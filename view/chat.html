<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Chat</title>
</head>
<body>
    <h2>WebSocket Chat</h2>
    <button onclick="logout()">Logout</button>
    <br><br>
    <label for="user_id">User ID: </label>
    <input type="text" id="receiver_id" placeholder="Receiver ID" required>
    <button onclick="connectWebSocket()">Connect</button>
    <button onclick="disconnectWebSocket()" id="disconnect-btn" style="display:none;">Disconnect</button>
    <br><br>

    <div id="chat-box" style="border: 1px solid #ddd; padding: 10px; width: 300px; height: 300px; overflow-y: scroll;">
        <p><em>Chat messages will appear here...</em></p>
    </div>

    <br><br>
    <textarea id="message" placeholder="Type your message"></textarea>
    <br><br>
    <button onclick="sendMessage()">Send Message</button>
    <br><br>
    <button onclick="clearChats()">Clear Chats</button>
    <button onclick="clearMessages()">Clear Message</button>

    <script>
        let socket;
    
        function connectWebSocket() {
            const receiverId = document.getElementById('receiver_id').value;
            const accessToken = localStorage.getItem('access_token');
            const userId = localStorage.getItem('email');  // Get the sender ID from local storage
    
            if (!receiverId || !accessToken || !userId) {
                alert("Ensure you are logged in and provide a Receiver ID!");
                return;
            }
    
            // Open WebSocket connection with sender ID, receiver ID, and access token
            socket = new WebSocket(`ws://localhost:8080/api/v1/chat/ws?user_id=${userId}&recipient_id=${receiverId}&access_token=${accessToken}`);
    
            // Handle opened connection
            socket.onopen = function() {
                appendMessage(`Connected as User ${userId}`);
                document.getElementById('disconnect-btn').style.display = 'inline';
            };
    
            // Listen for messages and history
            socket.onmessage = function(event) {
                const messageData = JSON.parse(event.data);
    
                if (Array.isArray(messageData)) {
                    // Assume messageData is an array of chat history on initial connection
                    messageData.forEach(msg => appendFormattedMessage(msg, userId));
                } else {
                    // Handle individual message
                    appendFormattedMessage(messageData, userId);
                }
            };
    
            // Handle closed connection
            socket.onclose = function(event) {
                appendMessage(`Disconnected (Code: ${event.code}, Reason: ${event.reason})`);
                document.getElementById('disconnect-btn').style.display = 'none';
            };
    
            socket.onerror = function(error) {
                console.error("WebSocket Error:", error);
            };
        }
    
        function sendMessage() {
            const receiverId = document.getElementById('receiver_id').value;
            const messageContent = document.getElementById('message').value;
            const userId = localStorage.getItem('email');
    
            if (!receiverId || !messageContent || !userId) {
                alert("Please enter both receiver ID and message content.");
                return;
            }
    
            const message = {
                sender: userId,
                receiver: receiverId,
                content: messageContent,
                time: new Date().toISOString()  // Adding time for consistency
            };
    
            // Send the message
            socket.send(JSON.stringify(message));
            appendMessage(`[${new Date().toLocaleString()}] You to ${receiverId}: ${messageContent}`);
            document.getElementById('message').value = '';
        }
    
        function appendFormattedMessage(messageData, userId) {
            const time = messageData.time ? new Date(messageData.time).toLocaleString() : "unknown time";
    
            if (messageData.receiver === userId) {
                appendMessage(`[${time}] ${messageData.sender} to You: ${messageData.content}`);
            } else {
                appendMessage(`[${time}] You to ${messageData.receiver}: ${messageData.content}`);
            }
        }
    
        function appendMessage(message) {
            const chatBox = document.getElementById('chat-box');
            const newMessage = document.createElement('p');
            newMessage.textContent = message;
            chatBox.appendChild(newMessage);
            chatBox.scrollTop = chatBox.scrollHeight;
        }
    
        function clearChats() {
            const chatBox = document.getElementById('chat-box');
            chatBox.innerHTML = '';
            appendMessage("<Chat history cleared...");
        }
    
        function clearMessages() {
            const messageArea = document.getElementById('message');
            messageArea.value = '';
        }
    
        function disconnectWebSocket() {
            if (socket) {
                socket.close();
            }
        }
    
        function logout() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('email');
            window.location.href = 'login.html';
        }
    </script>
</body>
</html>
