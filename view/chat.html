<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Chat</title>
</head>
<body>
    <h2>WebSocket Chat</h2>
    <button onclick="logout()">Logout</button>
    <br><br>
    <label for="user_id">User ID: </label>
    <input type="text" id="receiver_id" placeholder="Receiver ID" required>
    <button onclick="connectWebSocket()">Connect</button>
    <button onclick="disconnectWebSocket()" id="disconnect-btn" style="display:none;">Disconnect</button>
    <br><br>

    <div id="chat-box" style="border: 1px solid #ddd; padding: 10px; width: 300px; height: 300px; overflow-y: scroll;">
        <p><em>Chat messages will appear here...</em></p>
    </div>

    <br><br>
    <textarea id="message" placeholder="Type your message"></textarea>
    <br><br>
    <button onclick="sendMessage()">Send Message</button>
    <br><br>
    <button onclick="clearChats()">Clear Chats</button>
    <button onclick="clearMessages()">Clear Message</button>

    <script>
        let socket;

        function connectWebSocket() {
            const receiptId = document.getElementById('receiver_id').value;
            if (!receiptId) {
                alert("Please enter a Receiver ID!");
                return;
            }

            const accessToken = localStorage.getItem('access_token');
            if (!accessToken) {
                alert("You are not logged in!");
                return;
            }
            
            const id = localStorage.getItem('email');
            if (!id) {
                alert("You are not logged in!");
                return;
            }

            // Open WebSocket connection
            socket = new WebSocket(`ws://localhost:8080/api/v1/chat/ws?recipient_id=${receiptId}&access_token=${accessToken}`);
            // socket = new WebSocket(`ws://localhost:8080/api/v1/chat/ws?sender_id=${email}&recipient_id=${receiptId}&access_token=${accessToken}`);

            // Handle opened connection
            socket.onopen = function() {
                appendMessage(`Connected as User ${id}`);
                document.getElementById('disconnect-btn').style.display = 'inline';  // Show Disconnect button
            };

            // Listen for messages
            socket.onmessage = function(event) {
                const messageData = JSON.parse(event.data);

                // Format the time, if available
                const time = messageData.time ? new Date(messageData.time).toLocaleString() : "unknown time";

                // Check if the message is for the current user
                if (messageData.receiver === userId) {
                    appendMessage(`[${time}] ${messageData.sender} to You: ${messageData.content}`);
                } else {
                    appendMessage(`[${time}] You to ${messageData.receiver}: ${messageData.content}`);
                }
            };

            // Handle closed connection
            socket.onclose = function(event) {
                appendMessage(`Disconnected (Code: ${event.code}, Reason: ${event.reason})`);
                document.getElementById('disconnect-btn').style.display = 'none';  // Hide Disconnect button
            };

            // Error handling
            socket.onerror = function(error) {
                console.error("WebSocket Error:", error);
            };
        }

        function sendMessage() {
            const receiverId = document.getElementById('receiver_id').value;
            const messageContent = document.getElementById('message').value;

            if (!receiverId || !messageContent) {
                alert("Please enter both receiver ID and message content.");
                return;
            }
            
            const id = localStorage.getItem('email');
            if (!id) {
                alert("You are not logged in!");
                return;
            }

            const message = {
                sender: id,
                receiver: receiverId,
                content: messageContent
            };

            // Send the message
            socket.send(JSON.stringify(message));
            appendMessage(`[${new Date().toLocaleString()}] You to ${receiverId}: ${messageContent}`);
            document.getElementById('message').value = '';
        }

        function appendMessage(message) {
            const chatBox = document.getElementById('chat-box');
            const newMessage = document.createElement('p');
            newMessage.textContent = message;
            chatBox.appendChild(newMessage);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function clearChats() {
            const chatBox = document.getElementById('chat-box');
            chatBox.innerHTML = '';
            
            appendMessage("<Chat history cleared...");
        }

        function clearMessages() {
            const messageArea = document.getElementById('message');
            messageArea.value = '';
        }

        function disconnectWebSocket() {
            if (socket) {
                socket.close();
            }
        }

        function logout() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('email');
            window.location.href = 'login.html';
        }
    </script>
</body>
</html>
